# System Patterns: PostgreSQL MCP Server

## システムアーキテクチャ概要

### 全体アーキテクチャ
```
AI Assistant ↔ PostgreSQL MCP Server ↔ PostgreSQL Database
```

### 主要コンポーネント
1. **MCPサーバーコア** - プロトコルハンドリングとツール管理
2. **データベース接続層** - 接続プール管理とクエリ実行
3. **設定管理層** - 環境変数とセキュリティ設定
4. **ツールシステム** - CRUD、スキーマ、サンプリングツール

## 主要技術的決定

### 接続管理パターン
- **接続プーリング**: ConnectionPoolManagerによる効率的な接続管理
- **グローバルプール共有**: グローバルインスタンスによる接続共有
- **コンテキストマネージャ**: `with`文による安全な接続管理

### エラーハンドリングパターン
- 階層的なエラーハンドリング（データベースエラー、予期せぬエラー）
- 適切なロギングとエラーメッセージの提供

### セキュリティパターン
- **パラメータ化クエリ**: SQLインジェクション対策
- **環境変数管理**: 機密情報の安全な保存
- **入力バリデーション**: クエリパラメータの検証

## 設計パターン

### 主要なパターン
- **リポジトリパターン**: DatabaseManagerによるデータアクセスの抽象化
- **ファクトリパターン**: 接続プールの作成と管理
- **ストラテジーパターン**: クエリ実行戦略の分離

## 重要な実装パス

### MCPツール登録フロー
1. ツール定義の作成 → 2. MCPサーバーへの登録 → 3. ハンドラー設定 → 4. エラーハンドリング

### データベース接続フロー
1. 設定読み込み → 2. 接続プール初期化 → 3. 接続取得 → 4. クエリ実行 → 5. 結果処理

## コンポーネント関係

### 依存関係概要
```
MCP Server Core
├── Tool Registry (各種ツール)
├── Connection Manager (接続プール管理)
├── Configuration Manager (設定管理)
└── Resource Manager (リソース管理)
```

### データフロー
ツールリクエスト → パラメータ検証 → データベース接続 → クエリ実行 → 結果返却

## クリティカルな実装詳細

### 接続プール設定
- 最小接続数: 1
- 最大接続数: 20  
- 接続タイムアウト: 30秒
- アイドルタイムアウト: 300秒

### パフォーマンス考慮事項
- クエリタイムアウト管理（デフォルト30秒）
- 大きな結果セットのストリーミング処理
- 接続リークの防止とリソース解放

## 拡張性の考慮

### プラグインアーキテクチャ
- 新しいツールの簡単な追加
- カスタムクエリプロセッサのサポート
- 監視とロギングの拡張

### 設定の柔軟性
- 環境ごとの設定切り替え
- 動的な設定リロード
- 複数データベース接続のサポート

---
*詳細なコード例と実装の詳細は、必要に応じてソースコードを参照してください。*
