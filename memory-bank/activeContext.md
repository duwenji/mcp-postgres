# Active Context: PostgreSQL MCP Server

## 現在の作業状況

### 現在の焦点
- **uvビルドシステムへの移行完了**: hatchlingからuv_buildへの移行と検証
- **パッケージ構造の最適化**: 標準的なPythonパッケージ構造への変更
- **ドキュメントの更新**: 移行の仕組みと使用方法の詳細なドキュメント化

### 最近の変更
1. **ビルドシステムのuv_buildへの移行** (完了)
   - **pyproject.toml更新**: `[build-system]`セクションをuv_buildに変更
   - **不要な設定の削除**: `[tool.hatch.build.targets.wheel]`セクションの削除
   - **パッケージ構造の変更**: ソースコードを`src/mcp_postgres/`に移動
   - **スクリプトエントリーポイントの更新**: `mcp_postgres.main:main`に変更

2. **ビルドと実行の検証** (完了)
   - **ビルドテスト**: `uv build`による正常なパッケージ生成の確認
   - **インストールテスト**: 生成されたwheelファイルのインストール成功
   - **実行テスト**: `uv run mcp-postgres`によるサーバー起動の確認

3. **ドキュメントの作成と更新** (完了)
   - **新規ドキュメント**: `test/docs/uv_build_migration_guide.md`の作成
   - **README更新**: 実行コマンドを`uv run mcp-postgres`に統一
   - **日本語README更新**: README_ja.mdのサーバー実行コマンドを最新化

4. **技術スタックの最適化** (完了)
   - プログラミング言語: Python 3.10+
   - データベース接続: psycopg2-binary
   - MCPフレームワーク: 標準MCPプロトコル
   - 設定管理: Pydantic + 環境変数
   - パッケージ管理: uv
   - **ビルドシステム**: uv_build（hatchlingから移行）

## アクティブな決定と考慮事項

### 技術的決定
1. **Pythonの採用**: ユーザーの要望に基づきPythonを採用
2. **psycopg2の使用**: 安定したPostgreSQL接続ライブラリ
3. **環境変数による設定管理**: セキュリティと柔軟性の確保

### 設計上の考慮事項
- **接続プーリング**: 効率的なリソース管理の実装
- **非同期処理**: スケーラビリティの確保
- **セキュリティ**: SQLインジェクション対策と適切なエラーハンドリング

## 次のステップ

### 即時アクション (Phase 3: PostgreSQL接続機能の実装)
1. **データベース接続機能の実装**
   - 接続プールの実装と最適化
   - データベース接続管理の完成
   - クエリ実行エンジンの実装

2. **コアツールの実装**
   - SQLクエリ実行ツールの完成
   - テーブル構造取得ツールの実装
   - データ操作ツール（INSERT/UPDATE/DELETE）の実装

3. **スキーマ情報の外部提供**
   - テーブル一覧取得機能の実装
   - テーブル詳細スキーマ取得機能の実装
   - 動的リソース生成機能の完成

### 短期目標 (Phase 4: テストと検証)
1. **テスト環境の構築**
   - 単体テストの実装
   - 統合テストの設定
   - E2Eテストの準備

2. **品質保証**
   - コード品質チェックの実施
   - パフォーマンステストの実行
   - セキュリティテストの実施

## 重要なパターンと選好

### コーディング規約
- **型ヒントの使用**: コードの明瞭性とメンテナンス性向上
- **非同期プログラミング**: パフォーマンスとスケーラビリティ
- **構造化ロギング**: デバッグと監視の容易化

### 設定管理
- **環境変数優先**: セキュリティと環境ごとの設定切り替え
- **バリデーション**: Pydanticによる設定値の検証
- **デフォルト値**: 合理的なデフォルト設定の提供

### エラーハンドリング
- **詳細なエラーメッセージ**: デバッグの容易化
- **適切なロギングレベル**: 運用時の問題特定
- **ユーザーフレンドリーなエラー**: AIアシスタントへの適切なフィードバック

## 学習とプロジェクトの洞察

### 重要な学び
1. **MCPプロトコルの理解**: AIアシスタントとの効率的な連携方法
2. **PostgreSQL接続のベストプラクティス**: セキュリティとパフォーマンスの両立
3. **非同期Pythonプログラミング**: 現代的なサーバー実装のパターン

### プロジェクトの進化
- **初期要件**: 基本的なデータベース操作の提供
- **拡張可能性**: 将来の機能追加を見据えた設計
- **運用のしやすさ**: 設定とデプロイの簡素化

## 現在の課題と解決策

### 課題1: スキーマ情報の外部提供手段の欠如
- **状況**: AIがPostgreSQLのテーブルデータを参考にツールを呼ぶか否かを決定する際に、MCPサーバがこれらの情報を外に出す手段がない
- **解決策**: スキーマ取得ツールとリソース機能の実装
  - `get_tables`: 全テーブル一覧取得ツール
  - `get_table_schema`: テーブル詳細スキーマ取得ツール
  - スキーマリソースの実装

### 課題2: 接続プールの最適化
- **状況**: 効率的なリソース管理が必要
- **解決策**: SQLAlchemyまたは独自実装による接続プーリング

### 課題3: セキュリティ対策
- **状況**: SQLインジェクションのリスク
- **解決策**: パラメータ化クエリと入力バリデーション

### 課題4: エラーハンドリング
- **状況**: 様々なエラーケースへの対応
- **解決策**: 階層的なエラーハンドリングと適切なロギング

## 優先順位

### 高優先度
1. PostgreSQL接続機能の実装と最適化
2. コアツール（クエリ実行、テーブル取得、データ操作）の実装
3. スキーマ情報の外部提供機能の実装

### 中優先度
1. テスト環境の構築とテストケースの実装
2. エラーハンドリングの強化と詳細化
3. 設定管理システムの完成

### 低優先度
1. 高度な機能の実装（トランザクション管理、バッチ処理など）
2. 監視とロギングの強化
3. ドキュメントの充実とユーザーガイドの作成

## 次のアクション
1. **PostgreSQL接続機能の実装** (database.pyの完成)
2. **コアツールの実装** (tools/ディレクトリの完成)
3. **スキーマ情報の外部提供** (resources.pyの動的リソース生成)
4. **テスト環境の構築** (test/ディレクトリの充実)
