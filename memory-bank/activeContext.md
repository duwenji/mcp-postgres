# Active Context: PostgreSQL MCP Server

## 現在の作業状況

### 現在の焦点
- **PyPI公開完了**: パッケージ名を`mcp-postgres-duwenji`に変更してPyPIに公開
- **ドキュメントの更新**: パッケージ名変更を反映したドキュメント更新
- **テスト環境の更新**: 新しいパッケージ名に対応したテスト環境の調整

### 最近の変更
1. **PyPI公開の成功** (完了)
   - **パッケージ名変更**: `mcp-postgres`から`mcp-postgres-duwenji`に変更
   - **ソースディレクトリ名変更**: `src/mcp_postgres`から`src/mcp_postgres_duwenji`に変更
   - **PyPIへのアップロード**: 正常に公開完了（https://pypi.org/project/mcp-postgres-duwenji/1.0.0/）

2. **403 Forbiddenエラーの解決** (完了)
   - **原因特定**: 既存の`mcp-postgres`パッケージ名の所有権問題
   - **解決策**: 一意なパッケージ名への変更とソースディレクトリのリネーム
   - **学び**: PyPIでのパッケージ名の所有権確認の重要性

3. **ドキュメントの更新** (完了)
   - **PyPI公開ガイド**: 実際の公開経験を反映、パッケージ名を更新
   - **テストREADME**: パッケージ名を`mcp-postgres-duwenji`に更新
   - **設定ガイド**: 新しいパッケージ名に対応

4. **技術スタックの最適化** (完了)
   - プログラミング言語: Python 3.10+
   - データベース接続: psycopg2-binary
   - MCPフレームワーク: 標準MCPプロトコル
   - 設定管理: Pydantic + 環境変数
   - パッケージ管理: uv
   - **ビルドシステム**: uv_build
   - **公開パッケージ**: `mcp-postgres-duwenji` (PyPI)

## アクティブな決定と考慮事項

### 技術的決定
1. **Pythonの採用**: ユーザーの要望に基づきPythonを採用
2. **psycopg2の使用**: 安定したPostgreSQL接続ライブラリ
3. **環境変数による設定管理**: セキュリティと柔軟性の確保

### 設計上の考慮事項
- **接続プーリング**: 効率的なリソース管理の実装
- **非同期処理**: スケーラビリティの確保
- **セキュリティ**: SQLインジェクション対策と適切なエラーハンドリング

## 次のステップ

### 即時アクション (Phase 3: PostgreSQL接続機能の実装)
1. **データベース接続機能の実装**
   - 接続プールの実装と最適化
   - データベース接続管理の完成
   - クエリ実行エンジンの実装

2. **コアツールの実装**
   - SQLクエリ実行ツールの完成
   - テーブル構造取得ツールの実装
   - データ操作ツール（INSERT/UPDATE/DELETE）の実装

3. **スキーマ情報の外部提供**
   - テーブル一覧取得機能の実装
   - テーブル詳細スキーマ取得機能の実装
   - 動的リソース生成機能の完成

### 短期目標 (Phase 4: テストと検証)
1. **テスト環境の構築**
   - 単体テストの実装
   - 統合テストの設定
   - E2Eテストの準備

2. **品質保証**
   - コード品質チェックの実施
   - パフォーマンステストの実行
   - セキュリティテストの実施

## 重要なパターンと選好

### コーディング規約
- **型ヒントの使用**: コードの明瞭性とメンテナンス性向上
- **非同期プログラミング**: パフォーマンスとスケーラビリティ
- **構造化ロギング**: デバッグと監視の容易化

### 設定管理
- **環境変数優先**: セキュリティと環境ごとの設定切り替え
- **バリデーション**: Pydanticによる設定値の検証
- **デフォルト値**: 合理的なデフォルト設定の提供

### エラーハンドリング
- **詳細なエラーメッセージ**: デバッグの容易化
- **適切なロギングレベル**: 運用時の問題特定
- **ユーザーフレンドリーなエラー**: AIアシスタントへの適切なフィードバック

## 学習とプロジェクトの洞察

### 重要な学び
1. **MCPプロトコルの理解**: AIアシスタントとの効率的な連携方法
2. **PostgreSQL接続のベストプラクティス**: セキュリティとパフォーマンスの両立
3. **非同期Pythonプログラミング**: 現代的なサーバー実装のパターン

### プロジェクトの進化
- **初期要件**: 基本的なデータベース操作の提供
- **拡張可能性**: 将来の機能追加を見据えた設計
- **運用のしやすさ**: 設定とデプロイの簡素化

## 現在の課題と解決策

### 課題1: スキーマ情報の外部提供手段の欠如
- **状況**: AIがPostgreSQLのテーブルデータを参考にツールを呼ぶか否かを決定する際に、MCPサーバがこれらの情報を外に出す手段がない
- **解決策**: スキーマ取得ツールとリソース機能の実装
  - `get_tables`: 全テーブル一覧取得ツール
  - `get_table_schema`: テーブル詳細スキーマ取得ツール
  - スキーマリソースの実装

### 課題2: 接続プールの最適化
- **状況**: 効率的なリソース管理が必要
- **解決策**: SQLAlchemyまたは独自実装による接続プーリング

### 課題3: セキュリティ対策
- **状況**: SQLインジェクションのリスク
- **解決策**: パラメータ化クエリと入力バリデーション

### 課題4: エラーハンドリング
- **状況**: 様々なエラーケースへの対応
- **解決策**: 階層的なエラーハンドリングと適切なロギング

## 優先順位

### 高優先度
1. PostgreSQL接続機能の実装と最適化
2. コアツール（クエリ実行、テーブル取得、データ操作）の実装
3. スキーマ情報の外部提供機能の実装

### 中優先度
1. テスト環境の構築とテストケースの実装
2. エラーハンドリングの強化と詳細化
3. 設定管理システムの完成

### 低優先度
1. 高度な機能の実装（トランザクション管理、バッチ処理など）
2. 監視とロギングの強化
3. ドキュメントの充実とユーザーガイドの作成

## 次のアクション
1. **PostgreSQL接続機能の実装** (database.pyの完成)
2. **コアツールの実装** (tools/ディレクトリの完成)
3. **スキーマ情報の外部提供** (resources.pyの動的リソース生成)
4. **テスト環境の構築** (test/ディレクトリの充実)
